<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RECOMENDACIONES BARILOCHE</title>
  <style>
    :root{
      --bg:#f5f5f2; --card:#ffffff; --text:#222;
      --border:#ddd6c9; --segment:#cdbfa6; --thead:#e8e3d9;
      --row-border:#e7e1d6; --link:#3b3bb3;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);}
    .header{background:var(--bg);padding:20px;text-align:center;border-bottom:1px solid var(--border);}
    .header .title{margin:0;font-size:22px;font-weight:600;}
    .container{padding:16px;max-width:1000px;margin:auto;}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:20px;border:1px solid var(--border);}
    .menu a{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;margin:8px 0;text-decoration:none;color:var(--text);background:var(--bg);border-radius:10px;font-size:16px;font-weight:600;border:1px solid var(--border);transition:background .2s;}
    .menu a:hover{background:#ece9e1}
    .back{display:inline-block;margin-bottom:12px;text-decoration:none;color:#444;font-size:14px;cursor:pointer}
    h2{margin:8px 0 10px 0;font-size:26px;letter-spacing:.5px}
    .seg-buttons{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px;margin:6px 0 10px}
    .seg-btn{white-space:nowrap;background:#e9e4da;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;cursor:pointer}
    .seg-btn:hover{background:#e2dccf}
    .segment-pill{display:inline-block;background:var(--segment);color:#fff;padding:8px 14px;border-radius:10px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;margin:14px 0 8px}
    table{width:100%;border-collapse:collapse;margin:8px 0 18px;border:1px solid var(--border);border-radius:10px;overflow:hidden;table-layout:fixed;background:#fff;}
    thead th{background:var(--thead);text-align:left;font-weight:700;padding:12px 10px;font-size:15px;border-bottom:1px solid var(--border)}
    td{padding:10px;vertical-align:top;font-size:15px;line-height:1.45;border-bottom:1px solid var(--row-border);word-wrap:break-word;overflow-wrap:anywhere}
    tr:last-child td{border-bottom:none}
    a{color:var(--link)}
    .search{margin:12px 0;}
    .search input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff}
    @media(max-width:768px){
      .seg-btn{font-size:12px;padding:5px 10px}
      table,thead,tbody,tr,th,td{display:block}
      thead{display:none}
      tr{margin-bottom:14px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px}
      td{border:none;padding:6px 8px;position:relative;font-size:14px}
      td::before{content:attr(data-label);font-weight:700;display:block;margin-bottom:4px;color:#4f4b43;font-size:12px}
    }
  </style>
</head>
<body>
  <div class="header"><h1 class="title">RECOMENDACIONES BARILOCHE</h1></div>

  <div class="container">
    <!-- Menú -->
    <div id="menu" class="card">
      <div class="menu">
        <a href="#GASTRONOMIA"><span class="label">GASTRONOMIA</span><span>›</span></a>
        <a href="#PLAYAS"><span class="label">PLAYAS</span><span>›</span></a>
        <a href="#EXCURSIONES"><span class="label">EXCURSIONES</span><span>›</span></a>
      </div>
      <div class="note">Hacé clic en cada sección para ver su tabla.</div>
    </div>

    <!-- Contenido dinámico -->
    <div id="content">Cargando...</div>
  </div>

  <div class="footer" style="text-align:center;font-size:12px;color:#666;padding:20px;">Sitio generado con Google Sheets + GitHub Pages</div>

  <!-- =================== JS =================== -->
  <script>
    /* ===== CONFIG ===== */
    // API base (sin ?sheet=) — si cambia el deployment de Apps Script, actualizá esta URL:
    const API_URL = 'https://script.google.com/macros/s/AKfycbxavgGWY0dQcLOsaVfqII0DkQb-Tb5kqKfhsx2hRBvpdTwS_jrp3g4XSUSC5X2XBxxo1w/exec';

    // Definición de hojas, anchos y nombres de segmentos/botones
    const SHEETS = {
      GASTRONOMIA: {
        colWidths: ['20%','10%','12%','16%','42%'],
        segments: [
          {title:'ALMUERZO - CENA', label:'ALMUERZO-CENA'},
          {title:'DESAYUNO - MERIENDA', label:'DESAYUNO-MERIENDA'},
          {title:'VILLA LA ANGOSTURA', label:'VLA'}
        ]
      },
      PLAYAS: {
        colWidths: ['28%','22%','50%'],
        segments: [
          {title:'BARILOCHE', label:'BARILOCHE'},
          {title:'VILLA LA ANGOSTURA', label:'VLA'}
        ]
      },
      EXCURSIONES: {
        colWidths: ['28%','22%','50%'],
        segments: [{title:'BARILOCHE', label:'BARILOCHE'}]
      }
    };

    /* ===== Utilidades ===== */
    function esc(s){return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
    function slug(s){return s.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');}

    // Detecta filas-título de segmento (exact match con lista válida)
    function isSegmentRow(row, validTitles){
      let nonEmpty = 0, last = '';
      for (let i=0;i<row.length;i++){
        const s = String(row[i]||'').replace(/<[^>]+>/g,'').trim();
        if (s){ nonEmpty++; last = s; }
      }
      if (nonEmpty===1){
        const up = last.toUpperCase();
        for (let j=0;j<validTitles.length;j++){
          if (up === validTitles[j].toUpperCase()) return last;
        }
      }
      return null;
    }

    function buildButtons(section){
      const segs = SHEETS[section].segments;
      let html = '<div class="seg-buttons">';
      for (let i=0;i<segs.length;i++){
        html += '<button class="seg-btn" onclick="scrollToSeg(\''+slug(segs[i].title)+'\')">'+esc(segs[i].label)+'</button>';
      }
      html += '</div>';
      return html;
    }

    function makeTable(headers, rows, title, widths){
      if (!rows || !rows.length) return '';
      let colgroup = '';
      if (widths && widths.length===headers.length){
        colgroup = '<colgroup>';
        for (let i=0;i<widths.length;i++){ colgroup += '<col style="width:'+widths[i]+'">'; }
        colgroup += '</colgroup>';
      }
      let thead = '<thead><tr>';
      for (let h=0; h<headers.length; h++){ thead += '<th>'+esc(headers[h])+'</th>'; }
      thead += '</tr></thead>';

      let tbody = '<tbody>';
      for (let r=0;r<rows.length;r++){
        // evitar headers duplicados que vengan en los datos
        let dup=0;
        for (let c=0;c<headers.length && c<rows[r].length;c++){
          const cellTxt = String(rows[r][c]).replace(/<[^>]+>/g,'').trim().toUpperCase();
          if (cellTxt && cellTxt === String(headers[c]).trim().toUpperCase()) dup++;
        }
        if (dup >= Math.max(3, Math.floor(headers.length*0.6))) continue;

        tbody += '<tr>';
        for (let j=0; j<headers.length; j++){
          const label = esc(headers[j]||'');
          const html  = rows[r][j] || '';
          tbody += '<td data-label="'+label+'">'+ html +'</td>';
        }
        tbody += '</tr>';
      }
      tbody += '</tbody>';

      const anchor = 'seg-'+slug(title);
      return '<div id="'+anchor+'" class="segment-pill">'+esc(title)+'</div>' +
             '<table>'+ colgroup + thead + tbody + '</table>';
    }

    function buildSectionHTML(section, headers, allRows){
      const cfg = SHEETS[section];
      const validTitles = cfg.segments.map(s => s.title);

      let html  = '<a class="back" onclick="showMenu()">← Volver al menú</a>';
      html     += '<h2>'+esc(section)+'</h2>';
      html     += buildButtons(section);
      html     += '<div class="search"><input id="searchInput" type="search" placeholder="Buscar en todas las tablas..." oninput="filterTable()"></div>';

      let currentTitle = null;
      let currentRows = [];

      for (let r=0; r<allRows.length; r++){
        // descartar filas vacías
        let nonEmpty = 0;
        for (let k=0;k<allRows[r].length;k++){
          const s = String(allRows[r][k]||'').replace(/<[^>]+>/g,'').trim();
          if (s) nonEmpty++;
        }
        if (nonEmpty===0) continue;

        // ¿fila-segmento?
        const maybe = isSegmentRow(allRows[r], validTitles);
        if (maybe){
          if (currentRows.length){
            html += makeTable(headers, currentRows, currentTitle || validTitles[0], cfg.colWidths);
            currentRows = [];
          }
          currentTitle = maybe;
          continue;
        }
        // fila normal
        currentRows.push(allRows[r]);
      }
      if (currentRows.length){
        html += makeTable(headers, currentRows, currentTitle || validTitles[0], cfg.colWidths);
      }
      return html;
    }

    /* ===== Cache navegador + precarga ===== */
    const memCache = {};
    function cacheKey(section){ return 'sheet_' + section; }
    function getCached(section){
      if (memCache[section]) return memCache[section];
      const raw = sessionStorage.getItem(cacheKey(section));
      if (!raw) return null;
      try { return (memCache[section] = JSON.parse(raw)); } catch(e){ return null; }
    }
    function setCached(section, data){
      memCache[section] = data;
      try { sessionStorage.setItem(cacheKey(section), JSON.stringify(data)); } catch(e){}
    }

    async function fetchSheet(section){
      // 1) cache en memoria / sessionStorage
      const c = getCached(section);
      if (c) return c;

      // 2) red → API (tu Apps Script)
      const url = API_URL + '?sheet=' + encodeURIComponent(section);
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) throw new Error('API '+res.status);
      const data = await res.json();
      if (data.error) throw new Error(data.error);

      setCached(section, data);
      return data;
    }

    // Precalienta las otras secciones en segundo plano
    function prewarm(afterSection){
      const all = Object.keys(SHEETS);
      all.filter(s => s !== afterSection).forEach(s => {
        if (!getCached(s)){
          fetchSheet(s).catch(()=>{ /* ignorar */ });
        }
      });
    }

    /* ===== UI / Router ===== */
    function showMenu(){
      document.getElementById('menu').style.display='block';
      document.getElementById('content').innerHTML='';
      history.replaceState(null,'',location.pathname+location.search);
    }

    async function showSection(name){
      document.getElementById('menu').style.display='none';
      const cont = document.getElementById('content');
      cont.innerHTML = 'Cargando…';
      try{
        const data = await fetchSheet(name);        // ← usa cache si existe
        cont.innerHTML = buildSectionHTML(name, data.headers, data.rows);
        prewarm(name);                              // ← precarga las otras
      }catch(e){
        cont.innerHTML = '<p style="color:#b00020">No pude leer la hoja desde la API. '
          + 'Verificá que la Web App esté pública y la URL sea correcta.<br><br>'
          + esc(e.message) + '</p>';
      }
    }

    function filterTable(){
      const f = (document.getElementById('searchInput')?.value || '').toLowerCase();
      document.querySelectorAll('tbody tr').forEach(tr=>{
        tr.style.display = tr.innerText.toLowerCase().includes(f) ? '' : 'none';
      });
    }
    window.scrollToSeg = function(sl){
      const el = document.getElementById('seg-'+sl);
      if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
    };

    window.addEventListener('hashchange', ()=>{
      const h = location.hash.replace('#','');
      if (SHEETS[h]) showSection(h); else showMenu();
    });
    window.addEventListener('load', ()=>{
      const h = location.hash.replace('#','');
      if (SHEETS[h]) showSection(h); else showMenu();
    });

    // Exponer funciones usadas en HTML
    window.filterTable = filterTable;
    window.showMenu    = showMenu;
  </script>
</body>
</html>
