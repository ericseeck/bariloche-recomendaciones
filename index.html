<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RECOMENDACIONES BARILOCHE</title>
  <style>
    :root{
      --bg:#f5f5f2; --card:#ffffff; --text:#222;
      --border:#ddd6c9; --segment:#cdbfa6; --thead:#e8e3d9;
      --row-border:#e7e1d6; --link:#3b3bb3;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);}
    .header{background:var(--bg);padding:20px;text-align:center;border-bottom:1px solid var(--border);}
    .header .title{margin:0;font-size:22px;font-weight:600;}
    .container{padding:16px;max-width:1000px;margin:auto;}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:20px;border:1px solid var(--border);}
    .menu a{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;margin:8px 0;text-decoration:none;color:var(--text);background:var(--bg);border-radius:10px;font-size:16px;font-weight:600;border:1px solid var(--border);transition:background .2s;}
    .menu a:hover{background:#ece9e1}
    .back{display:inline-block;margin-bottom:12px;text-decoration:none;color:#444;font-size:14px;cursor:pointer}
    h2{margin:8px 0 10px 0;font-size:26px;letter-spacing:.5px}
    .seg-buttons{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px;margin:6px 0 10px}
    .seg-btn{white-space:nowrap;background:#e9e4da;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;cursor:pointer}
    .seg-btn:hover{background:#e2dccf}
    .segment-pill{display:inline-block;background:var(--segment);color:#fff;padding:8px 14px;border-radius:10px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;margin:14px 0 8px}
    table{width:100%;border-collapse:collapse;margin:8px 0 18px;border:1px solid var(--border);border-radius:10px;overflow:hidden;table-layout:fixed;background:#fff;}
    thead th{background:var(--thead);text-align:left;font-weight:700;padding:12px 10px;font-size:15px;border-bottom:1px solid var(--border)}
    td{padding:10px;vertical-align:top;font-size:15px;line-height:1.45;border-bottom:1px solid var(--row-border);word-wrap:break-word;overflow-wrap:anywhere}
    tr:last-child td{border-bottom:none}
    a{color:var(--link)}
    .search{margin:12px 0;}
    .search input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff}
    @media(max-width:768px){
      .seg-btn{font-size:12px;padding:5px 10px}
      table,thead,tbody,tr,th,td{display:block}
      thead{display:none}
      tr{margin-bottom:14px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px}
      td{border:none;padding:6px 8px;position:relative;font-size:14px}
      td::before{content:attr(data-label);font-weight:700;display:block;margin-bottom:4px;color:#4f4b43;font-size:12px}
    }
  </style>
</head>
<body>
  <div class="header"><h1 class="title">RECOMENDACIONES BARILOCHE</h1></div>
  <div class="container">
    <div id="menu" class="card">
      <div class="menu">
        <a href="#GASTRONOMIA"><span class="label">GASTRONOMIA</span><span>›</span></a>
        <a href="#PLAYAS"><span class="label">PLAYAS</span><span>›</span></a>
        <a href="#EXCURSIONES"><span class="label">EXCURSIONES</span><span>›</span></a>
      </div>
      <div class="note">Hacé clic en cada sección para ver su tabla.</div>
    </div>
    <div id="content"></div>
  </div>
  <div class="footer" style="text-align:center;font-size:12px;color:#666;padding:20px;">Sitio generado con Google Sheets + GitHub Pages</div>

  <script>
    /*** PONÉ ACÁ TU URL /exec del Web App ***/
    const API_URL = "https://script.google.com/macros/s/AKfycbxavgGWY0dQcLOsaVfqII0DkQb-Tb5kqKfhsx2hRBvpdTwS_jrp3g4XSUSC5X2XBxxo1w/exec"; // ej: https://script.google.com/macros/s/AKfyc.../exec

    const SHEETS = {
      GASTRONOMIA: {
        headers: ["NOMBRE","UBICACION","IG","PRECIOS","COMENTARIOS"],
        colWidths: ["20%","10%","12%","16%","42%"],
        segments: [
          {title:"ALMUERZO - CENA", label:"ALMUERZO-CENA"},
          {title:"DESAYUNO - MERIENDA", label:"DESAYUNO-MERIENDA"},
          {title:"VILLA LA ANGOSTURA", label:"VLA"}
        ]
      },
      PLAYAS: {
        headers: ["NOMBRE","UBICACION","COMENTARIOS"],
        colWidths: ["28%","22%","50%"],
        segments: [
          {title:"BARILOCHE", label:"BARILOCHE"},
          {title:"VILLA LA ANGOSTURA", label:"VLA"}
        ]
      },
      EXCURSIONES: {
        headers: ["NOMBRE","UBICACION","COMENTARIOS"],
        colWidths: ["28%","22%","50%"],
        segments: [{title:"BARILOCHE", label:"BARILOCHE"}]
      }
    };

    const esc = s => String(s==null?"":s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    // --- Carga desde tu API (preserva <a href>) ---
    async function loadViaApi(section){
      const url = `${API_URL}?sheet=${encodeURIComponent(section)}`;
      const res = await fetch(url, {cache:"no-store"});
      if (!res.ok) throw new Error("API HTTP "+res.status);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      // Formato de salida: array de arrays con HTML dentro
      const rows = data.rows;
      const headers = data.headers && data.headers.length ? data.headers : SHEETS[section].headers;
      return { rows, headers };
    }

    // --- Fallback CSV por si la API no estuviera publicada ---
    const SHEET_ID = "1Kr3AIdE6fl8rVtv9lWRprLMOSYtxhcSUDkeFES9AyIw";
    const GIDS = { GASTRONOMIA:"1720586403", PLAYAS:"1968374221", EXCURSIONES:"222330063" };

    function parseCSV(t){
      const rows=[]; let row=[], cell="", q=false;
      for(let i=0;i<t.length;i++){ const ch=t[i], nx=t[i+1];
        if(q){ if(ch==='"'&&nx==='"'){cell+='"';i++;} else if(ch==='"'){q=false;} else cell+=ch; }
        else { if(ch==='"') q=true; else if(ch===','){row.push(cell);cell="";} else if(ch==='\n'){row.push(cell);rows.push(row);row=[];cell="";} else if(ch!=='\r') cell+=ch; }
      }
      row.push(cell); if(row.length) rows.push(row);
      return rows.filter(r => r.some(c => String(c).trim()!==""));
    }
    function autoLinkVisibleUrls(rows){
      return rows.map(r => r.map(c => /^https?:\/\/\S+$/i.test(c) ? `<a href="${c}" target="_blank" rel="noopener">${c}</a>` : esc(c)));
    }
    async function loadViaCsv(section){
      const gid = GIDS[section];
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
      const res = await fetch(url, {cache:"no-store"});
      if (!res.ok) throw new Error("CSV HTTP "+res.status);
      const text = await res.text();
      const rows = autoLinkVisibleUrls(parseCSV(text));
      return { rows, headers: SHEETS[section].headers };
    }

    // --- Segmentación / Render ---
    function detectHeaderRow(rows, expected){
      const wanted = expected.map(x=>x.toUpperCase());
      for (let r=0;r<Math.min(rows.length,80);r++){
        const up = rows[r].map(x=>String(x).replace(/<[^>]+>/g,"").trim().toUpperCase());
        const hits = wanted.filter(w=>up.includes(w)).length;
        const non = up.filter(x=>x!=="").length;
        if (hits>=2 || (hits===0 && non>=3 && r>0)) return r;
      }
      return 0;
    }
    function isSegRow(cells, validTitles){
      const set = validTitles.map(t=>t.toUpperCase());
      let cnt=0,last=""; for(const c of cells){ const s=String(c).replace(/<[^>]+>/g,"").trim(); if(s){cnt++;last=s;} }
      return (cnt===1 && set.includes(last.toUpperCase())) ? last : null;
    }
    const slug = s => s.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
    function buildButtons(section){
      const btns = SHEETS[section].segments.map(seg=>`<button class="seg-btn" onclick="scrollToSeg('${slug(seg.title)}')">${esc(seg.label)}</button>`).join("");
      return `<div class="seg-buttons">${btns}</div>`;
    }
    function makeTable(headers, rows, title, widths){
      if (!rows.length) return "";
      const colgroup = (widths && widths.length===headers.length) ? "<colgroup>"+widths.map(w=>`<col style="width:${w}">`).join("")+"</colgroup>" : "";
      const thead = "<thead><tr>"+headers.map(h=>`<th>${esc(h)}</th>`).join("")+"</tr></thead>";
      let tbody = "<tbody>";
      for (const r of rows){
        const rU = r.map(x=>String(x).replace(/<[^>]+>/g,"").trim().toUpperCase());
        const hU = headers.map(x=>String(x).trim().toUpperCase());
        let m=0; for(let i=0;i<Math.min(rU.length,hU.length);i++){ if(rU[i] && rU[i]===hU[i]) m++; }
        if (m >= Math.max(3, Math.floor(hU.length*0.6))) continue;
        tbody += "<tr>";
        for (let j=0;j<headers.length;j++){
          const label=esc(headers[j]||""); const html=r[j]||"";
          tbody += `<td data-label="${label}">${html}</td>`;
        }
        tbody += "</tr>";
      }
      tbody += "</tbody>";
      const anchor = slug(title);
      return `<div id="seg-${anchor}" class="segment-pill">${esc(title)}</div><table>${colgroup}${thead}${tbody}</table>`;
    }
    function buildSegmentedHTML(allRows, section){
      const cfg = SHEETS[section], valid = cfg.segments.map(s=>s.title);
      const headerRow = detectHeaderRow(allRows, cfg.headers);
      const headers = allRows[headerRow].map(v=>String(v).replace(/<[^>]+>/g,"").trim());
      let html = `<a class="back" onclick="showMenu()">← Volver al menú</a><h2>${esc(section)}</h2>${buildButtons(section)}<div class="search"><input id="searchInput" type="search" placeholder="Buscar en todas las tablas..." oninput="filterTable()"></div>`;
      let currTitle=null, curr=[];
      for(let r=0;r<headerRow;r++){ const maybe=isSegRow(allRows[r], valid); if(maybe) currTitle=maybe; }
      for(let r=headerRow+1;r<allRows.length;r++){
        const row=allRows[r];
        if (row.every(c => String(c).replace(/<[^>]+>/g,"").trim()==="")) continue;
        const maybe=isSegRow(row, valid);
        if (maybe){ if (curr.length){ html+=makeTable(headers, curr, currTitle||valid[0], cfg.colWidths); curr=[]; } currTitle=maybe; continue; }
        curr.push(row);
      }
      if (curr.length) html += makeTable(headers, curr, currTitle||valid[0], cfg.colWidths);
      return html;
    }

    // --- UI / Router ---
    function showMenu(){ document.getElementById("menu").style.display="block"; document.getElementById("content").innerHTML=""; history.replaceState(null,"",location.pathname+location.search); }
    async function showSection(name){
      document.getElementById("menu").style.display="none";
      const cont=document.getElementById("content"); cont.innerHTML="Cargando…";
      try{
        const { rows, headers } = await loadViaApi(name);  // ✅ links preservados
        cont.innerHTML = buildSegmentedHTML([headers, ...rows], name);
      }catch(_){
        try{
          const { rows, headers } = await loadViaCsv(name); // último recurso
          cont.innerHTML = buildSegmentedHTML([headers, ...rows], name);
        }catch(e){
          cont.innerHTML = `<p style="color:#b00020">No pude leer la hoja. Revisá que la API de Apps Script esté publicada (“Cualquiera”) y la URL /exec esté bien en <code>API_URL</code>.</p>`;
        }
      }
    }
    function filterTable(){ const f=(document.getElementById("searchInput")?.value||"").toLowerCase(); document.querySelectorAll("tbody tr").forEach(tr=>{ tr.style.display=tr.innerText.toLowerCase().includes(f)?"":"none"; }); }
    window.scrollToSeg = sl => { const el=document.getElementById("seg-"+sl); if (el) el.scrollIntoView({behavior:"smooth", block:"start"}); };

    window.addEventListener("hashchange", ()=>{ const h=location.hash.replace("#",""); if (SHEETS[h]) showSection(h); else showMenu(); });
    window.addEventListener("load", ()=>{ const h=location.hash.replace("#",""); if (SHEETS[h]) showSection(h); else showMenu(); });

    window.filterTable=filterTable; window.showMenu=showMenu;
  </script>
</body>
</html>
        return esc(s);
      }));
    }

    async function loadSheetTable(sectionCfg){
      // 1) GViz
      try{
        const table = await fetchGViz(sectionCfg.gid);
        return { rows: gvizToRows(table), via: "gviz" };
      }catch(_){}
      // 2) PubHTML (si está publicado)
      try{
        const rows = await fetchPubHTML(sectionCfg.gid);
        return { rows, via: "pubhtml" };
      }catch(_){}
      // 3) CSV
      const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${sectionCfg.gid}`;
      const res = await fetch(csvUrl, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV HTTP " + res.status);
      const text = await res.text();
      const rows = autoLinkVisibleUrls(parseCSV(text));
      return { rows, via: "csv" };
    }

    /* ======== Segmentación y render ======== */

    function detectHeaderRow(rows, expected){
      const wanted = expected.map(x=>x.toUpperCase());
      const max = Math.min(rows.length, 80);
      for (let r=0; r<max; r++){
        const upper = rows[r].map(c => String(c || "").replace(/<[^>]+>/g,"").trim().toUpperCase());
        const nonEmpty = upper.filter(x=>x!=="").length;
        const hits = wanted.filter(w => upper.includes(w)).length;
        if (hits >= 2) return r;
        if (hits === 0 && nonEmpty >= 3 && r>0) return r; // fallback
      }
      return 0;
    }

    function isSegmentRow(cells, validTitles){
      const set = validTitles.map(t => t.toUpperCase());
      let nonEmpty=0, last="";
      for (const c of cells){
        const s = String(c || "").replace(/<[^>]+>/g,"").trim();
        if (s){ nonEmpty++; last = s; }
      }
      return (nonEmpty===1 && set.includes(last.toUpperCase())) ? last : null;
    }

    const slug = s => s.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");

    function buildButtons(section){
      const cfg = SHEETS[section];
      const btns = cfg.segments.map(seg =>
        `<button class="seg-btn" onclick="scrollToSeg('${slug(seg.title)}')">${esc(seg.label)}</button>`
      ).join("");
      return `<div class="seg-buttons">${btns}</div>`;
    }

    function makeTable(headers, rows, title, widths){
      if (!rows || !rows.length) return "";
      const colgroup = (widths && widths.length===headers.length)
        ? "<colgroup>"+widths.map(w=>`<col style="width:${w}">`).join("")+"</colgroup>" : "";
      const thead = "<thead><tr>"+headers.map(h=>`<th>${esc(h)}</th>`).join("")+"</tr></thead>";

      let tbody = "<tbody>";
      for (const r of rows){
        // saltar headers duplicados
        const rU = r.map(x => String(x).replace(/<[^>]+>/g,"").trim().toUpperCase());
        const hU = headers.map(x => String(x).trim().toUpperCase());
        let matches=0; for (let i=0;i<Math.min(rU.length,hU.length);i++){ if(rU[i] && rU[i]===hU[i]) matches++; }
        if (matches >= Math.max(3, Math.floor(hU.length*0.6))) continue;

        tbody += "<tr>";
        for (let j=0; j<headers.length; j++){
          const label = esc(headers[j] || "");
          const html  = r[j] || "";
          tbody += `<td data-label="${label}">${html}</td>`;
        }
        tbody += "</tr>";
      }
      tbody += "</tbody>";

      const anchor = slug(title);
      return `<div id="seg-${anchor}" class="segment-pill">${esc(title)}</div>
              <table>${colgroup}${thead}${tbody}</table>`;
    }

    function buildSegmentedHTML(allRows, section){
      const cfg = SHEETS[section];
      const validTitles = cfg.segments.map(s=>s.title);

      const headerRow = detectHeaderRow(allRows, cfg.headers);
      const header = allRows[headerRow].map(v => String(v || "").replace(/<[^>]+>/g,"").trim());

      let html = `
        <a class="back" onclick="showMenu()">← Volver al menú</a>
        <h2>${esc(section)}</h2>
        ${buildButtons(section)}
        <div class="search"><input id="searchInput" type="search" placeholder="Buscar en todas las tablas..." oninput="filterTable()"></div>
      `;

      let currentTitle = null;
      for (let r=0; r<headerRow; r++){
        const maybe = isSegmentRow(allRows[r], validTitles);
        if (maybe) currentTitle = maybe;
      }

      let currentRows = [];
      for (let r=headerRow+1; r<allRows.length; r++){
        const row = allRows[r];
        if (row.every(c => String(c).replace(/<[^>]+>/g,"").trim()==="")) continue;

        const maybe = isSegmentRow(row, validTitles);
        if (maybe){
          if (currentRows.length){
            html += makeTable(header, currentRows, currentTitle || validTitles[0], cfg.colWidths);
            currentRows = [];
          }
          currentTitle = maybe;
          continue;
        }
        currentRows.push(row);
      }
      if (currentRows.length){
        html += makeTable(header, currentRows, currentTitle || validTitles[0], cfg.colWidths);
      }
      return html;
    }

    /* ============== UI / Router ============== */
    function showMenu(){
      document.getElementById("menu").style.display="block";
      document.getElementById("content").innerHTML="";
      history.replaceState(null,"",location.pathname+location.search);
    }
    async function showSection(name){
      document.getElementById("menu").style.display="none";
      const cont = document.getElementById("content");
      cont.innerHTML="Cargando…";
      try{
        const { rows } = await loadSheetTable(SHEETS[name]);
        cont.innerHTML = buildSegmentedHTML(rows, name);
      }catch(e){
        cont.innerHTML = `<p style="color:#b00020">
          No pude leer la hoja (GViz/PubHTML/CSV). Verificá:
          <br>• Permiso “Cualquier persona con el enlace – Lector”.
          <br>• (Recomendado) “Archivo → Publicar en la web”.
        </p>`;
      }
    }
    function filterTable(){
      const f = (document.getElementById("searchInput")?.value || "").toLowerCase();
      document.querySelectorAll("tbody tr").forEach(tr=>{
        tr.style.display = tr.innerText.toLowerCase().includes(f) ? "" : "none";
      });
    }
    window.scrollToSeg = function(sl){
      const el = document.getElementById("seg-"+sl);
      if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
    };

    window.addEventListener("hashchange", ()=>{
      const h = location.hash.replace("#","");
      if (SHEETS[h]) showSection(h); else showMenu();
    });
    window.addEventListener("load", ()=>{
      const h = location.hash.replace("#","");
      if (SHEETS[h]) showSection(h); else showMenu();
    });

    window.filterTable = filterTable;
    window.showMenu    = showMenu;
  </script>
</body>
</html>

