<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RECOMENDACIONES BARILOCHE</title>
  <style>
    /* ===== Paleta y base ===== */
    :root{
      --bg:#f5f5f2;          /* fondo general */
      --card:#ffffff;        /* tarjetas */
      --border:#ddd6c9;      /* borde suave/beige */
      --text:#222;

      --segment:#cdbfa6;     /* pill de segmento (ALMUERZO - CENA) */
      --thead:#e8e3d9;       /* fondo encabezado tabla (un tono más oscuro que el fondo de la tabla) */
      --row-border:#e7e1d6;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);}
    .header{background:var(--bg);padding:20px;text-align:center;border-bottom:1px solid var(--border);}
    .header .title{margin:0;font-size:22px;font-weight:600;}
    .container{padding:16px;max-width:1000px;margin:auto;}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:20px;border:1px solid var(--border);}

    /* ===== Menú ===== */
    .menu a{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 16px;margin:8px 0;text-decoration:none;color:var(--text);
      background:var(--bg);border-radius:10px;font-size:16px;font-weight:600;
      border:1px solid var(--border);
      transition:background .2s, transform .02s;
    }
    .menu a:hover{background:#ece9e1}
    .menu .label{flex:1}

    .back{display:inline-block;margin-bottom:12px;text-decoration:none;color:#444;font-size:14px;cursor:pointer}

    h2{margin:8px 0 12px 0;font-size:26px;letter-spacing:.5px}

    /* ===== Segmentos & Tablas ===== */
    .segment-pill{
      display:inline-block;
      background:var(--segment); color:#fff;
      padding:8px 14px; border-radius:10px;
      font-weight:700; letter-spacing:.6px; text-transform:uppercase;
      margin:10px 0;
    }

    table{width:100%;border-collapse:collapse;margin:10px 0 18px;border:1px solid var(--border);border-radius:10px;overflow:hidden;table-layout:fixed;background:#fff;}
    thead th{
      background:var(--thead);
      text-align:left; font-weight:700; padding:12px 10px; font-size:15px;
      border-bottom:1px solid var(--border);
    }
    td{
      padding:10px; vertical-align:top; font-size:15px; line-height:1.45;
      border-bottom:1px solid var(--row-border);
      word-wrap:break-word; overflow-wrap:anywhere;
    }
    tr:last-child td{border-bottom:none}
    a{color:#3b3bb3}

    /* Buscador */
    .search{margin:12px 0;}
    .search input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff}

    /* Mobile: tarjetas */
    @media(max-width:768px){
      table,thead,tbody,tr,th,td{display:block}
      thead{display:none}
      tr{margin-bottom:14px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px}
      td{border:none;padding:6px 8px;position:relative;font-size:14px}
      td::before{content:attr(data-label);font-weight:700;display:block;margin-bottom:4px;color:#4f4b43;font-size:12px}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">RECOMENDACIONES BARILOCHE</h1>
  </div>

  <div class="container">
    <!-- Menú -->
    <div id="menu" class="card">
      <div class="menu">
        <a href="#GASTRONOMIA"><span class="label">GASTRONOMIA</span><span>›</span></a>
        <a href="#PLAYAS"><span class="label">PLAYAS</span><span>›</span></a>
        <a href="#EXCURSIONES"><span class="label">EXCURSIONES</span><span>›</span></a>
      </div>
      <div class="note">Hacé clic en cada sección para ver su tabla.</div>
    </div>

    <!-- Contenido de sección -->
    <div id="content"></div>
  </div>

  <div class="footer" style="text-align:center;font-size:12px;color:#666;padding:20px;">
    Sitio generado con Google Sheets + GitHub Pages
  </div>

  <script>
    /* ========= CONFIG ========= */
    const SHEET_ID = "1Kr3AIdE6fl8rVtv9lWRprLMOSYtxhcSUDkeFES9AyIw";
    const SHEETS = {
      "GASTRONOMIA": { gid:"1720586403", headers:["NOMBRE","UBICACION","IG","PRECIOS","COMENTARIOS"], colWidths:["22%","12%","6%","18%","42%"] },
      "PLAYAS":      { gid:"1968374221", headers:["NOMBRE","UBICACION","COMENTARIOS"],                 colWidths:["28%","22%","50%"] },
      "EXCURSIONES": { gid:"222330063", headers:["NOMBRE","UBICACION","COMENTARIOS"],                 colWidths:["28%","22%","50%"] }
    };

    function sheetCsvUrl(gid){
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
    }

    /* ========= CSV robusto ========= */
    function parseCSV(text){
      const rows = [];
      let row = [], cell = "", quote = false;
      for (let i=0; i<text.length; i++){
        const ch = text[i], nx = text[i+1];
        if (quote){
          if (ch === '"' && nx === '"'){ cell += '"'; i++; }
          else if (ch === '"'){ quote = false; }
          else { cell += ch; }
        } else {
          if (ch === '"'){ quote = true; }
          else if (ch === ','){ row.push(cell); cell = ""; }
          else if (ch === '\n'){ row.push(cell); rows.push(row); row = []; cell = ""; }
          else if (ch === '\r'){ /* skip */ }
          else { cell += ch; }
        }
      }
      row.push(cell);
      if (row.length) rows.push(row);
      return rows.filter(r => r.some(c => String(c).trim() !== ""));
    }

    function esc(s){
      return String(s==null?"":s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    /* ========= Detección de encabezado y segmentación ========= */
    function detectHeaderRow(rows, expected){
      const wanted = expected.map(x => x.toUpperCase());
      const max = Math.min(rows.length, 80);
      for (let r=0; r<max; r++){
        const upper = rows[r].map(c => String(c||"").trim().toUpperCase());
        const nonEmpty = upper.filter(x => x !== "").length;
        const hits = wanted.filter(w => upper.includes(w)).length;
        if (hits >= 2) return r;
        if (hits === 0 && nonEmpty >= 3 && r>0) return r; // fallback
      }
      return 0;
    }

    function isSegmentTitleRow(cells){
      let nonEmpty = 0, last = "";
      for (const c of cells){
        const s = String(c||"").trim();
        if (s){ nonEmpty++; last = s; }
      }
      return (nonEmpty === 1) ? last : null;
    }

    function buildSegmentedHTML(rows, sheetName){
      const cfg = SHEETS[sheetName];
      const headerRow = detectHeaderRow(rows, cfg.headers);
      const header = rows[headerRow].map(v => String(v||"").trim());

      let html = `
        <a class="back" onclick="showMenu()">← Volver al menú</a>
        <h2>${esc(sheetName)}</h2>
        <div class="search"><input id="searchInput" type="search" placeholder="Buscar en todas las tablas..." oninput="filterTable()"></div>
      `;

      let currentRows = [];
      let currentTitle = null;

      function flush(){
        if (!currentRows.length) return;
        // colgroup
        let colgroup = "";
        const widths = (cfg.colWidths.length === header.length) ? cfg.colWidths
                     : Array.from({length:header.length}, ()=> (Math.round(100/Math.max(1,header.length))+"%"));
        colgroup = "<colgroup>" + widths.map(w => `<col style="width:${w}">`).join("") + "</colgroup>";

        // thead
        const thead = "<thead><tr>" + header.map(h=>`<th>${esc(h)}</th>`).join("") + "</tr></thead>";

        // tbody
        let tbody = "<tbody>";
        for (const r of currentRows){
          // filtrar headers duplicados
          const rU = r.map(x=>String(x||"").trim().toUpperCase());
          const hU = header.map(x=>String(x||"").trim().toUpperCase());
          let matches = 0; for (let i=0;i<Math.min(rU.length,hU.length);i++){ if (rU[i] && rU[i]===hU[i]) matches++; }
          const enough = Math.max(3, Math.floor(hU.length*0.6));
          if (matches >= enough) continue;

          tbody += "<tr>";
          for (let j=0;j<header.length;j++){
            const label = esc(header[j]||"");
            const raw = r[j] || "";
            const isUrl = /^https?:\/\//i.test(raw);
            const val = esc(raw);
            const cellHtml = isUrl ? `<a href="${raw}" target="_blank" rel="noopener">${val}</a>` : val;
            tbody += `<td data-label="${label}">${cellHtml}</td>`;
          }
          tbody += "</tr>";
        }
        tbody += "</tbody>";

        html += `<div class="segment-pill">${esc(currentTitle || sheetName)}</div>
                 <table>${colgroup}${thead}${tbody}</table>`;
        currentRows = [];
      }

      // recorrer datos a partir del header
      for (let r = headerRow + 1; r < rows.length; r++){
        const row = rows[r];
        const maybeTitle = isSegmentTitleRow(row);
        if (maybeTitle){
          flush();
          currentTitle = maybeTitle;
          continue;
        }
        currentRows.push(row);
      }
      flush();
      return html;
    }

    /* ========= Carga y render ========= */
    async function loadSheet(name){
      const cfg = SHEETS[name];
      if (!cfg) return `<p style="color:#b00020">Sección inválida.</p>`;
      const url = sheetCsvUrl(cfg.gid);
      try{
        const res = await fetch(url, { cache:'no-store' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        const rows = parseCSV(text);
        return buildSegmentedHTML(rows, name);
      }catch(err){
        return `<p style="color:#b00020">No pude leer la hoja (${esc(err.message)}). Verificá que el Sheet esté “Cualquiera con el enlace – Lector” o “Publicado en la web”.</p>`;
      }
    }

    /* ========= Buscador ========= */
    function filterTable(){
      const input = document.getElementById('searchInput');
      if (!input) return;
      const f = input.value.toLowerCase();
      document.querySelectorAll('tbody tr').forEach(tr=>{
        tr.style.display = tr.innerText.toLowerCase().includes(f) ? "" : "none";
      });
    }

    /* ========= UI ========= */
    function showMenu(){
      document.getElementById("menu").style.display = "block";
      document.getElementById("content").innerHTML = "";
      history.replaceState(null,"",location.pathname+location.search); // limpia hash
    }

    async function showSection(name){
      document.getElementById("menu").style.display = "none";
      document.getElementById("content").innerHTML = "Cargando…";
      document.getElementById("content").innerHTML = await loadSheet(name);
    }

    window.addEventListener("hashchange", async ()=>{
      const hash = location.hash.replace("#","");
      if (SHEETS[hash]) showSection(hash); else showMenu();
    });

    window.addEventListener("load", async ()=>{
      const hash = location.hash.replace("#","");
      if (SHEETS[hash]) showSection(hash);
    });

    // Exponer buscador al scope global (para el input oninput)
    window.filterTable = filterTable;
    window.showMenu = showMenu;
  </script>
</body>
</html>
